# Распределенный калькулятор
Распределенный калькулятор — это система, которая выполняет математические выражения, разбивая их на задачи<br>
и распределяя вычисления между агентами. Система поддерживает операции сложения, вычитания, умножения и деления,<br>
а также учитывает приоритет операций и скобки. Выражения могут содержать пробелы, которые игнорируются при обработке<br>

## Основные возможности

Поддержка операций: +, -, *, /<br>
Приоритет операций: Учитывается порядок выполнения операций (умножение и деление имеют приоритет над сложением<br>
и вычитанием).<br>
Скобки: Поддержка вложенных скобок для изменения порядка вычислений.<br>
Распределенные вычисления: выражения разбиваются на задачи, которые выполняются агентами.<br>
HTTP API: Взаимодействие с системой происходит через REST API.<br>

## Архитектура

### Система состоит из двух основных компонентов:

### Оркестратор:
- Принимает математические выражения от пользователя.
- Разбивает выражения на задачи.
- Распределяет задачи между агентами.<br>
- Собирает результаты и возвращает итоговый результат.
### Агент:
- Получает задачи от оркестратора.
- Выполняет вычисления.
- Возвращает результаты оркестратору.

## Установка и запуск

### Требования

Установленный Go (версия 1.16 или выше).

### Склонируйте репозиторий:
```bash
git clone https://github.com/ivanov-nikolay/distributed_calculator.git
```
Перейдите в корневую директорию скачанного проекта
```shell
cd <директория-проекта>
```

Требуется установка сторонних библиотек

```shell
go get -u github.com/joho/godotenv
go get github.com/stretchr/testify
go mod tidy
```

### Откройте терминал. Запустите оркестратор:
```shell
go run cmd/orchestrator/main.go
```
Оркестратор будет доступен на http://localhost:8080<br>

### Откройте еще один терминал. Запуск агента
```shell
go run cmd/agent/main.go
```
Агент начнет запрашивать задачи у оркестратора и выполнять их.

## HTTP API

### *1. Отправка выражения на вычисление*

### Запрос:

Метод: POST
URL: /api/v1/calculate<br>
Тело запроса (JSON):
```json
{
"expression": "(5 - 2) * (1 + 8) / (1 + 77)"
}
```
### Ответ:

Статус: 201 Created<br>
Тело ответа (JSON):
```json
{
"id": "1"
}
```
### *2. Получение списка выражений*

### Запрос:

Метод: GET
URL: /api/v1/expressions
### Ответ:
Статус: 200 OK<br>
Тело ответа (JSON):
```json
{
  "expressions": [
    {
      "id": "1",
      "expression": "(5 - 2) * (1 + 8) / (1 + 77)",
      "status": "completed",
      "result": 0.34615385
    }
  ]
}
```
### *3. Получение выражения по ID*

### Запрос:

Метод: GET<br>
URL: /api/v1/expressions/{id}<br>
### Ответ:

Статус: 200 OK<br>
Тело ответа (JSON):
```json
{
  "expression": {
    "id": "1",
    "expression": "(5 - 2) * (1 + 8) / (1 + 77)",
    "status": "completed",
    "result": 0.34615385
  }
}
```
### *4. Получение задачи агентом*

### Запрос:

Метод: GET<br>
URL: /internal/task<br>
### Ответ:<br>

Статус: 200 OK<br>
Тело ответа (JSON):
```json
{
  "task": {
    "id": "1",
    "arg1": 5,
    "arg2": 2,
    "operation": "-",
    "operation_time": 1000
  }
}
```
### *5. Отправка результата агентом*

### Запрос:

Метод: POST
URL: /internal/task<br>
Тело запроса (JSON):<br>
```json
{
  "id": "1",
  "result": 3
}
```
### Ответ:

Статус: 200 OK<br>
## Коды ошибок

### Система возвращает следующие HTTP-коды ошибок:

- 400 Bad Request: Некорректный запрос (например, неверный формат данных)<br>
- 404 Not Found: Запрошенный ресурс не найден (например, выражение с указанным ID отсутствует)<br>
- 405 Method Not Allowed: Использован неподдерживаемый HTTP-метод<br>
- 422 Unprocessable Entity: Невозможно обработать запрос (например, некорректное математическое выражение)<br>
- 500 Internal Server Error: Внутренняя ошибка сервера<br>

## Примеры использования

### *Пример 1: Вычисление выражения*

### Откройте еще один терминал (уже третий по счету). Отправьте выражение на вычисление:
```bash
curl -X POST http://localhost:8080/api/v1/calculate \
-H "Content-Type: application/json" \
-d '{"expression": "(5 - 2) * (1 + 8) / (1 + 77)"}'
```
Ответ
```json
{
  "id":"1"
}
```
### Получите результат:
```bash
curl http://localhost:8080/api/v1/expressions/1
```
Ответ:
```json
{
    "expressions": [
        {
            "id": "1",
            "expression": "(5 - 2) * (1 + 8) / (1 + 77)",
            "status": "pending",
            "result": 0
        }
    ]
}
```
Происходит вычисление: **"status": "pending"**, отправьте запрос еще раз:
```bash
curl http://localhost:8080/api/v1/expressions/1
```
Ответ:
```json
{
    "expressions": [
        {
            "id": "1",
            "expression": "(5 - 2) * (1 + 8) / (1 + 77)",
            "status": "completed",
            "result": 0.346154
        }
    ]
}
```
### *Пример 2: Получение списка выражений*
### Отправьте еще одно выражение на вычисление:
```bash
curl -X POST http://localhost:8080/api/v1/calculate \
-H "Content-Type: application/json" \
-d '{"expression": "10 * (1 - 8) / (10 - 77)"}'
```
Ответ
```json
{
  "id":"2"
}
```
Дождитесь окончания вычисления (несколько секунд):

```bash
curl http://localhost:8080/api/v1/expressions
```
Ответ
```json
{
    "expressions": [
        {
            "id": "1",
            "expression": "(5 - 2) * (1 + 8) / (1 + 77)",
            "status": "completed",
            "result": 0.346154
        },
        {
            "id": "2",
            "expression": "10 * (1 - 8) / (10 - 77)",
            "status": "completed",
            "result": 1.044776
        }
    ]
}
```

## Тестирование
Запустите оркестратор и агента<br>
Для запуска тестов в корневой директории проекта выполните команду:

```bash
go test -v ./...
```

## Схема работы приложения: Оркестратор и Агент

## Схема взаимодействия между Оркестратором и Агентом в распределенном калькуляторе.

Она иллюстрирует, как данные передаются между компонентами и как задачи обрабатываются.

## Общая схема
```

+-------------------+       +-------------------+       +-------------------+
|                   |       |                   |       |                   |
|   Пользователь    | ----> |    Оркестратор    | <---> |      Агент        |
|                   |       |                   |       |                   |
+-------------------+       +-------------------+       +-------------------+
```
## Детализация работы

### 1. Пользователь отправляет выражение:<br>
- Пользователь отправляет HTTP-запрос на /api/v1/calculate с математическим выражением.<br>
### 2. Оркестратор принимает выражение, создает уникальный ID и сохраняет его в хранилище выражений.<br>
Разбор выражения на задачи:<br>
- Оркестратор разбивает выражение на токены и преобразует их в обратную польскую запись (RPN).<br>
- На основе RPN создаются задачи (например, 5 - 2, 1 + 8, 3 * 9 и т.д.).<br>
- Задачи сохраняются в хранилище задач.<br>
- Агент запрашивает задачу:<br>
- Агент отправляет HTTP-запрос на /internal/task для получения задачи.<br>
- Оркестратор возвращает задачу из хранилища задач.<br>
- Агент выполняет задачу:<br>
- Агент вычисляет результат задачи (например, 5 - 2 = 3).<br>
- Агент отправляет результат обратно на /internal/task.<br>
- Оркестратор собирает результаты:<br>
- Оркестратор сохраняет результат задачи в хранилище результатов.<br>
- Если все задачи для выражения выполнены, Оркестратор вычисляет финальный результат и обновляет статус выражения.<br>
### 3. Пользователь запрашивает результат<br>
### 4. Пользователь отправляет HTTP-запрос на /api/v1/expressions/{id} для получения результата<br>
### 5. Оркестратор возвращает результат выражения<br>
## Схема взаимодействия
```
+-------------------+       +-------------------+       +-------------------+
|                   |       |                   |       |                   |
|   Пользователь    |       |    Оркестратор    |       |      Агент        |
|                   |       |                   |       |                   |
+--------+----------+       +---------+---------+       +---------+---------+
|                            |                           |
| 1. POST /calculate         |                           |
+--------------------------> |                           |
|                            |                           |
| 2. Создание выражения      |                           |
|    и разбор на задачи      |                           |
|                            |                           |
|                            | 3. GET /internal/task     |
|                            | <-------------------------+
|                            |                           |
|                            | 4. Возврат задачи         |
|                            +-------------------------->|
|                            |                           |
|                            | 5. Вычисление задачи      |
|                            |                           |
|                            | 6. POST /internal/task    |
|                            | <-------------------------+
|                            |                           |
|                            | 7. Сохранение результата  |
|                            |                           |
| 8. GET /expressions/{id}   |                           |
+--------------------------> |                           |
|                            |                           |
| 9. Возврат результата      |                           |
| <--------------------------+                           |
|                            |                           |
+--------+----------+       +---------+---------+       +---------+---------+
|                   |       |                   |       |                   |
|   Пользователь    |       |    Оркестратор    |       |      Агент        |
|                   |       |                   |       |                   |
+-------------------+       +-------------------+       +-------------------+
```
## Описание компонентов

### Оркестратор:
- Принимает выражения от пользователя.
- Разбивает выражения на задачи.
- Управляет хранилищами выражений, задач и результатов.
- Отдает задачи агентам и собирает результаты.
### Агент:
- Запрашивает задачи у Оркестратора.
- Выполняет вычисления (сложение, вычитание, умножение, деление).
- Отправляет результаты обратно Оркестратору.
### Пользователь:
- Отправляет выражения на вычисление.
- Запрашивает результаты вычислений.
### Пример работы
Пользователь отправляет выражение:
```bash
curl -X POST http://localhost:8080/api/v1/calculate \
-H "Content-Type: application/json" \
-d '{"expression": "(5 - 2) * (1 + 8) / (1 + 77)"}'
```
Оркестратор разбивает выражение на задачи:<br>
- Задача 1: 5 - 2
- Задача 2: 1 + 8
- Задача 3: 1 + 77
- Задача 4: 3 * 9
- Задача 5: 27 / 78
  Агент запрашивает задачи, выполняет их и отправляет результаты.<br>
  Оркестратор вычисляет финальный результат:<br>
  (5 - 2) * (1 + 8) / (1 + 77) = 0.34615385<br>
  Пользователь запрашивает результат:<br>
```bash
curl http://localhost:8080/api/v1/expressions/1
```


### Автор

telegram: @ivanovnickv<br>
ivanovnickv@gmail.com<br>
https://github.com/ivanov-nikolay/distributed_calculator<br>

